

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>L10: Frequency Synthesis and Detection &mdash; Real Time Digital Signal Processing B Term 2020  documentation</title>
  

  
  
  
  

  

  
  
    

  

  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Labs" href="labs.html" />
    <link rel="prev" title="L9: Adaptive Filters" href="lecture9.html" /> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> Real Time Digital Signal Processing B Term 2020
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="syllabus.html">Syllabus</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="lectures.html">Lectures</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="introduction.html">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="lecture1.html">L1: Sampling and Quantization, Reconstruction</a></li>
<li class="toctree-l2"><a class="reference internal" href="lecture2.html">L2: Real-Time Input Output</a></li>
<li class="toctree-l2"><a class="reference internal" href="lecture3.html">L3: DTFT, z-transform, and FIR filters</a></li>
<li class="toctree-l2"><a class="reference internal" href="lecture4.html">L4: FIR filter implementation</a></li>
<li class="toctree-l2"><a class="reference internal" href="lecture5.html">L5: IIR filters, and their implementation</a></li>
<li class="toctree-l2"><a class="reference internal" href="lecture6.html">L6: Fixed Point Arithmetic in DSP</a></li>
<li class="toctree-l2"><a class="reference internal" href="lecture7.html">L7: Performance Optimization in DSP</a></li>
<li class="toctree-l2"><a class="reference internal" href="lecture8.html">L8: DMA and the ARM CMSIS Library</a></li>
<li class="toctree-l2"><a class="reference internal" href="lecture9.html">L9: Adaptive Filters</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">L10: Frequency Synthesis and Detection</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#what-is-frequency-synthesis-and-detection">What is Frequency Synthesis and Detection?</a></li>
<li class="toctree-l3"><a class="reference internal" href="#direct-digital-frequency-synthesis">Direct Digital Frequency Synthesis</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#phase-generator">Phase Generator</a></li>
<li class="toctree-l4"><a class="reference internal" href="#waveform-generator">Waveform Generator</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#frequency-synthesis-in-action-audio-frequency-shift-keying">Frequency Synthesis in action: Audio Frequency Shift Keying</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#afsk-modulator">AFSK modulator</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#frequency-detection-goertzel-algorithm">Frequency Detection: Goertzel Algorithm</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#goertzel-filter-implementation">Goertzel Filter Implementation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#goertzel-algorithm">Goertzel algorithm</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#frequency-detection-in-action-dtmf-decoding">Frequency Detection in action: DTMF Decoding</a></li>
<li class="toctree-l3"><a class="reference internal" href="#conclusions">Conclusions</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="labs.html">Labs</a></li>
<li class="toctree-l1"><a class="reference internal" href="techdoc.html">Technical Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="howto.html">How-To Guides</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Real Time Digital Signal Processing B Term 2020</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
          <li><a href="lectures.html">Lectures</a> &raquo;</li>
        
      <li>L10: Frequency Synthesis and Detection</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/lecture10.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="l10-frequency-synthesis-and-detection">
<h1>L10: Frequency Synthesis and Detection<a class="headerlink" href="#l10-frequency-synthesis-and-detection" title="Permalink to this headline">¶</a></h1>
<p>The purpose of this lecture is as follows.</p>
<ul class="simple">
<li>To discuss the role of frequency synthesis and detection in digital communication systems</li>
<li>To describe a design for a flexible frequency synthesis system, based on Direct Digital Frequency Synthesis (DDFS) and the CORDIC algorithm</li>
<li>To describe a design for a flexible frequency detection system, based on the Goertzel algorithm for frequency detection</li>
<li>To describe Audio Frequency Shift Keying as an example digital communication system</li>
</ul>
<div class="section" id="what-is-frequency-synthesis-and-detection">
<h2>What is Frequency Synthesis and Detection?<a class="headerlink" href="#what-is-frequency-synthesis-and-detection" title="Permalink to this headline">¶</a></h2>
<p>Digital communication is an important subfield of DSP - if not the main subfield. A digital communication
system transmits discrete messages from a sender to a received over an analog medium, typically wireless.
As part of the transmission, each message is converted into one or more symbols, who are then <em>modulated</em> into an analog waveform suitable for transmission over the medium. At the receiver side, the waveforms
are de-modulated back into symbols, which allow to reconstruct the discrete message. The modulation process is typically done in two steps. First, a <em>pulse modulation</em> process converts discrete symbol
pulses into a sampled-data waveform. Next, a <em>bandpass modulation</em> process modulates a carrier
frequency using the sample-data waveform.</p>
<div class="figure align-center" style="width: 600px">
<img alt="_images/digicom.jpg" src="_images/digicom.jpg" />
</div>
<p>There are many different techniques to implement
pulse modulation and bandpass modulation, and an in-depth discussion of them is out of scope for
this course.  However, each of the building
blocks in a digital communications system is a DSP design problem in its own. Pulse modulation, for example, which converts symbols into a bandwidth-limited waveform, can be implemented using digital FIR filters. At the receiver side, the symbol detection process converts the same bandwidth-limited waveform
back into symbols, and that process too, can be described as a digital FIR filtering problem.</p>
<p>In  this lecture, we will specific describe the process of Frequency Synthesis and Frequency Detection,
two operations that can be found back in nearly every digital communications system. Frequency synthesis
is often used during bandpass modulation and demodulation; while frequency detection is often found
as a mechanism for symbol detection.</p>
<div class="admonition important">
<p class="first admonition-title">Important</p>
<p><strong>Frequency Synthesis</strong> is the problem of generating a periodic waveform in real time, which
a selected frequency, phase and amplitude. We are specifically interested in the case
of sine and cosine generation.</p>
<p class="last"><strong>Frequency Detection</strong> is the problem of recognizing that a given signal has a frequency
component of selected frequency at a power level higher than a given threshold level.</p>
</div>
<p>We will describe one technique for frequency synthesis as well as one technique for frequency detection. Eventually, we will describe a more complete digital communications system called Audio Frequency Shift Keying, as an application for Frequency Synthesis and Frequency Detection.</p>
</div>
<div class="section" id="direct-digital-frequency-synthesis">
<h2>Direct Digital Frequency Synthesis<a class="headerlink" href="#direct-digital-frequency-synthesis" title="Permalink to this headline">¶</a></h2>
<p>A <em>Direct Digital Frequency Synthesis</em> (DDFS) system supports the generation of a periodic sine
waveform of a selected frequency. It consists of a phase generator that drives a phase-to-waveform
converter. The phase quantizer is an optional block that reduces the number of phase bits and as
such can reduce the complexity of the phase-to-waveform process.</p>
<div class="figure align-center" style="width: 500px">
<img alt="_images/ddfs.jpg" src="_images/ddfs.jpg" />
</div>
<div class="section" id="phase-generator">
<h3>Phase Generator<a class="headerlink" href="#phase-generator" title="Permalink to this headline">¶</a></h3>
<p>The phase generator is an N-bit accumulator ACC that is incremented with a given increment
DINC, an integer number. The increment operation is done at the rate of the sample frequency <img class="math" src="_images/math/00cc7b93584f504a49a9f4895973bc434576dcdd.png" alt="F_s"/>. Assuming that a full circle angle (<img class="math" src="_images/math/6f064faadf14a1d739a4ca4e1ea4aeeb3a342dfe.png" alt="2\pi"/>) is represented as an integer with <img class="math" src="_images/math/81e79f244ba3a8a833d8b0edcd320d3efe352660.png" alt="2^N"/> bits, then the frequency of the output waveform <img class="math" src="_images/math/4a16ec64a855c6d8cf782c18239119a95cce9b17.png" alt="F_o &lt; F_s"/> corresponding to an increment DINC is given by the following expression.</p>
<div class="math">
<p><img src="_images/math/c3ae2fced76ec8a2b1c5751e311e09b7c5cfef2f.png" alt="F_o = \frac{F_s}{2^N} DINC"/></p>
</div><p>For a given target output frequency <img class="math" src="_images/math/3f8d27b639566fdf0a526e9eaf485bea54e8a038.png" alt="F_o"/>, the required phase increment DINC is computed as follows.</p>
<div class="math">
<p><img src="_images/math/0509015ad47fe22202926db26ce9a9e0ab817c5e.png" alt="DINC = \lfloor \frac{F_o 2^N}{F_s} + 0.5 \rfloor"/></p>
</div><p>Since the smallest DINC is 1, it follows that the lowest output frequency that can be generated
by the DDFS system is given by the following expression.</p>
<div class="math">
<p><img src="_images/math/46a2b2522ae8878f902f157d5515ab459c467abe.png" alt="F_{o,min} = \frac{F_s}{2^N}"/></p>
</div><p>All frequencies generated are multiples of the lowest output frequency <img class="math" src="_images/math/c7217fc325d494d52e3a0f647701806cc705857d.png" alt="F_{o,min}"/>. The highest
output frequency that can be generated is of course the Nyquist frequency <img class="math" src="_images/math/cb0f4e767990264d3f65e0393ee0542cafcf1c09.png" alt="\frac{F_s}{2}"/>. In practice, the output frequency is limited to <img class="math" src="_images/math/b25dd071afbc2f6a2e8db43ed96d1e08bbe55cd8.png" alt="\frac{F_s}{4}"/> to reduce the complexity of the
reconstruction filter used at the output of the phase-to-waveform generator.
The number of bits <img class="math" src="_images/math/f4170ed8938b79490d8923857962695514a8e4cb.png" alt="N"/> therefore defines the frequency step <img class="math" src="_images/math/c7217fc325d494d52e3a0f647701806cc705857d.png" alt="F_{o,min}"/> of the DDFS.
<img class="math" src="_images/math/f4170ed8938b79490d8923857962695514a8e4cb.png" alt="N"/> can be directly computed as follows.</p>
<div class="math">
<p><img src="_images/math/789ca0ef05b17886fde630edd289033257db9703.png" alt="N = \lceil log_2 (\frac{F_s}{F_{o,min}}) \rceil"/></p>
</div><p>For example, with a system with <img class="math" src="_images/math/366fdd26b9d24ef254e09e00b4b2a22226b30fb2.png" alt="F_s = 16KHz"/> and a desired resolution of 100Hz, we need an <img class="math" src="_images/math/f4170ed8938b79490d8923857962695514a8e4cb.png" alt="N"/> of at least 8 bits.</p>
</div>
<div class="section" id="waveform-generator">
<h3>Waveform Generator<a class="headerlink" href="#waveform-generator" title="Permalink to this headline">¶</a></h3>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The example code of this section is included in the repository
from this lecture as <code class="docutils literal notranslate"><span class="pre">dsp_l10_cosperf</span></code></p>
</div>
<p>With the phase captured in ACC, we then have to produce a sine (or cosine) function
corresponding to <img class="math" src="_images/math/cb8b06f5b436246867b85f377fa1a2d14196c52d.png" alt="sin(2\pi\frac{ACC}{2^N})"/>. In practice, the sine function is not
computed in real time, because it is too compute intensive. For example, even a simple
cosine as in the following function requires 3531 cycles on an ARM Cortex M4.
Real-time computation of trigonometric functions is therefore always specialized.</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">int</span> <span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="n">uint16_t</span> <span class="n">processSample</span><span class="p">(</span><span class="n">uint16_t</span> <span class="n">s</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">float32_t</span> <span class="n">phase</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">M_PI</span> <span class="o">/</span> <span class="mf">1024.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">k</span><span class="p">;</span>
    <span class="n">k</span> <span class="o">=</span> <span class="p">(</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1023</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">f32_to_dac14</span><span class="p">(</span><span class="mf">0.1</span> <span class="o">*</span> <span class="n">cos</span><span class="p">(</span><span class="n">phase</span><span class="p">));</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The most common form of specialization is to use a lookup table with <img class="math" src="_images/math/81e79f244ba3a8a833d8b0edcd320d3efe352660.png" alt="2^N"/> pre-computed
values. The values are stored at a precision of M bits, so that a <img class="math" src="_images/math/526c1fceaa5d2a26317b6165775ee89636a11643.png" alt="2^N \times M"/> bit lookup table is needed. In case <img class="math" src="_images/math/81e79f244ba3a8a833d8b0edcd320d3efe352660.png" alt="2^N"/> is very large, the lookup table with sine values will be large as well. For those cases, the phase may have to be quantized to a lower resolution before table lookup.</p>
<p>The quantization of the phase to <img class="math" src="_images/math/9dcbbef8e0f76051d388013b90a95bec3069e484.png" alt="P"/> on the one hand, and the quantization of the amplitude to <img class="math" src="_images/math/450a8e2c2320d77181e0d4fc68c947e9a5de8ecb.png" alt="M"/> bits on the other hand, each result in additional quantization noise.</p>
<ul class="simple">
<li>Quantization of the phase results in phase noise and a spectral effect known as <em>spurs</em>, additional peaks that appear at a non-linear relationship to the original waveform.</li>
<li>Quantization of the amplitude results in quantization noise, an overall increase of the noise floor of the output signal.</li>
</ul>
<p>Without going into a detailed noise analysis, we will only make the following qualitative observation: <em>the number of bits P to represent the phase must be approximately equal to
the number of output bits M to represent the output signal</em>. If <img class="math" src="_images/math/f88eca9e5cad1cdbaac6065e22ef1309b72f2000.png" alt="P &lt;&lt; M"/>, the quantization noise in the system will be dominated by phase noise, and the additional resolution at the output is wasted. If <img class="math" src="_images/math/f07538ac7d4c653c5affd46d7e5858d74b13259f.png" alt="M &lt;&lt; P"/>, the quantization noise in the system
will be dominated by amplitude quantization noise, and the additional precision to represent
the phase is wasted.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The example code of this section is included in the repository
from this lecture as <code class="docutils literal notranslate"><span class="pre">dsp_l10_cosspurs</span></code></p>
</div>
<p>The following program let’s you experiment with the effect of quantization noise and phase noise. By default, phase is quantization on 10 bits, and the amplitude on 15 fractional bits.
By changing the macros <code class="docutils literal notranslate"><span class="pre">PHASEQ</span></code> and <code class="docutils literal notranslate"><span class="pre">COSBITS</span></code> you can investigate the impact of phase noise and amplitude noise on the output spectrum.</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">sets</span> <span class="n">the</span> <span class="n">phase</span> <span class="n">resolution</span> <span class="p">(</span><span class="mi">2</span><span class="o">^</span><span class="n">P</span> <span class="k">with</span> <span class="n">P</span> <span class="o">~</span> <span class="n">number</span> <span class="n">of</span> <span class="n">bits</span> <span class="ow">in</span> <span class="n">phase</span><span class="p">)</span>
<span class="c1">#define PHASEQ 1024</span>

<span class="o">//</span> <span class="n">sets</span> <span class="n">the</span> <span class="n">frequency</span> <span class="n">step</span> <span class="p">(</span><span class="mi">2</span><span class="o">^</span><span class="n">N</span> <span class="k">with</span> <span class="n">N</span> <span class="o">~</span> <span class="n">number</span> <span class="n">of</span> <span class="n">bits</span> <span class="ow">in</span> <span class="n">accumulator</span><span class="p">)</span>
<span class="c1">#define STEPQ 1024</span>

<span class="o">//</span> <span class="n">sets</span> <span class="n">the</span> <span class="n">ouput</span> <span class="n">resolution</span> <span class="p">(</span><span class="n">M</span> <span class="o">~</span> <span class="n">number</span> <span class="n">of</span> <span class="n">bits</span> <span class="ow">in</span> <span class="n">output</span><span class="p">,</span> <span class="mi">1</span> <span class="o">..</span> <span class="mi">15</span><span class="p">)</span>
<span class="c1">#define COSBITS 15</span>

<span class="nb">int</span> <span class="n">coslu</span><span class="p">[</span><span class="n">PHASEQ</span><span class="p">];</span>
<span class="n">void</span> <span class="n">initcoslu</span><span class="p">()</span> <span class="p">{</span>
    <span class="nb">int</span> <span class="n">i</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">PHASEQ</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
        <span class="n">coslu</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="nb">int</span><span class="p">)</span> <span class="p">(</span><span class="mf">0.1</span> <span class="o">*</span> <span class="n">cosf</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">M_PI</span> <span class="o">*</span> <span class="n">i</span> <span class="o">/</span> <span class="n">PHASEQ</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">COSBITS</span><span class="p">)))</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">15</span> <span class="o">-</span>    <span class="n">COSBITS</span><span class="p">);</span>
<span class="p">}</span>

<span class="nb">int</span> <span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="n">uint16_t</span> <span class="n">processSample</span><span class="p">(</span><span class="n">uint16_t</span> <span class="n">s</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">float32_t</span> <span class="n">phase</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">M_PI</span> <span class="o">/</span> <span class="n">STEPQ</span><span class="p">)</span> <span class="o">*</span> <span class="n">k</span><span class="p">;</span>
    <span class="n">k</span> <span class="o">=</span> <span class="p">(</span><span class="n">k</span> <span class="o">+</span> <span class="mi">100</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">STEPQ</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">q15_to_dac14</span><span class="p">(</span><span class="n">coslu</span><span class="p">[</span><span class="n">k</span> <span class="o">/</span> <span class="p">(</span><span class="n">STEPQ</span><span class="o">/</span><span class="n">PHASEQ</span><span class="p">)]);</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="figure align-center" id="id3" style="width: 600px">
<img alt="_images/spectrum_a15_p10.jpg" src="_images/spectrum_a15_p10.jpg" />
<p class="caption"><span class="caption-text">DDFS Spectrum for output Amplitude 15 fractional bits, Phase 10 bits</span></p>
</div>
<div class="figure align-center" id="id4" style="width: 600px">
<img alt="_images/spectrum_a7_p10.jpg" src="_images/spectrum_a7_p10.jpg" />
<p class="caption"><span class="caption-text">DDFS Spectrum for output Amplitude 7 fractional bits, Phase 10 bits</span></p>
</div>
<div class="figure align-center" id="id5" style="width: 600px">
<img alt="_images/spectrum_a15_p5.jpg" src="_images/spectrum_a15_p5.jpg" />
<p class="caption"><span class="caption-text">DDFS Spectrum for output Amplitude 15 fractional bits, Phase 5 bits</span></p>
</div>
</div>
</div>
<div class="section" id="frequency-synthesis-in-action-audio-frequency-shift-keying">
<h2>Frequency Synthesis in action: Audio Frequency Shift Keying<a class="headerlink" href="#frequency-synthesis-in-action-audio-frequency-shift-keying" title="Permalink to this headline">¶</a></h2>
<p>Among the many digital modulation formats available, one stands out because of its simplicity and its compatibility with audio-band signal modulation: Audio Frequency Shift Keying or AFSK. AFSK is widely used in amateur radio (as the physical layer for the AX.25 packet radio protocol) and for NOAA weather radio.</p>
<p>In AFSK1200, symbols are encoded at a rate of 1200 symbols per second. Each symbol is either a mark (‘1’) or else a space (‘0’). Each symbol is modulated using frequencies at 1200Hz (mark frequency) or at 2200Hz (space frequency). A mark symbol is send as a mark frequency for a duration of one symbol period; a space symbol is send as a space frequency for a duration of one symbol period. Each mark symbol lasts of exactly one period at the mark frequency. Each space symbol lasts for 1.83 periods of the space frequency.</p>
<p>AFSK modulation needs to have continuous phase, so that the transition between AFSK symbols is smooth (i.e., does not have sudden jumps). This ensures that the bandwidth of the resulting signal remains narrow. The AFSK modulation signal is generated as follows.</p>
<div class="math">
<p><img src="_images/math/d5ea962e45a89d4bb376239ede68a68a3c5ebb20.png" alt="s(t) = cos( 2 \pi f_c t + 2 \pi \Delta f \int_0^t m(\tau) d \tau )"/></p>
</div><p>For AFSK1200, <img class="math" src="_images/math/9fa6cc33af4eb9f6aea21a25739484b8983f6bc1.png" alt="f_c = 1700 Hz"/> and <cite>Delta f = 500 Hz</cite>. The symbols are encoded as <img class="math" src="_images/math/3f036ad8355c284443b96f76676d53279c722204.png" alt="m(\tau) = 1"/> for a space symbol and <img class="math" src="_images/math/3e5fe44fda5a11cb0d279770c6f4353ff851cf2b.png" alt="m(\tau) = -1"/> for a mark symbol. The instantaneous frequency of this signal is given by the following expression.</p>
<div class="math">
<p><img src="_images/math/e22b58e5714df053ab9801f86e65d8f78b8f9365.png" alt="f &amp;= \frac{d}{dt} (2 \pi f_c t + 2 \pi \Delta f \int_0^t m(\tau) d \tau) \\
  &amp;= 2 \pi f_c + 2 \pi \Delta f m(t)"/></p>
</div><p>So that the instantanous frequency is indeed either 1200Hz or else 2200Hz.</p>
<div class="section" id="afsk-modulator">
<h3>AFSK modulator<a class="headerlink" href="#afsk-modulator" title="Permalink to this headline">¶</a></h3>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The example code of this section is included in the repository
from this lecture as <code class="docutils literal notranslate"><span class="pre">dsp_l10_afsk_modulator</span></code></p>
</div>
<p>An AFSK modulator can be implemented using the same technique as a DDFS: select a phase increment that is proportional to the mark or space frequency, and then generate the selected frequency for the period of a single symbol.</p>
<p>The following function shows the core of the AFSK modulator.</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span>int next_sample(int start, int stop) {
    samplectr = samplectr + 1;

    if (samplectr == SS) {
        currentsymbol = next_symbol(start, stop);
        samplectr = 0;
    }

    angle = angle + 2*(CFS + GFS * currentsymbol);
    angle = (angle &gt; (1 &lt;&lt; 16)) ? angle - (1 &lt;&lt; 16) : angle;

    int mycos = coslu[angle &gt;&gt; 8];
}
</pre></div>
</div>
<p>The following are relevant variables in this code:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">angle</span></code> is the DDFS phase as a 15-bit number. A full circle (<img class="math" src="_images/math/70b18b02102d304259bfe6eb9e38350b5993f6d0.png" alt="2 \pi"/>) equals :math:<a href="#id1"><span class="problematic" id="id2">`</span></a>2^{16}.</li>
<li><code class="docutils literal notranslate"><span class="pre">samplectr</span></code> counts the samples in a symbol, from 0 to <code class="docutils literal notranslate"><span class="pre">SS</span> <span class="pre">-</span> <span class="pre">1</span></code>.</li>
<li><code class="docutils literal notranslate"><span class="pre">CFS</span></code> is the 1700Hz center frequency scaled according to the sample frequency, and expressed as a DDFS increment. In this design we are using a 24KHz sample frequency, so that <code class="docutils literal notranslate"><span class="pre">CFS</span></code> equals <code class="docutils literal notranslate"><span class="pre">(int)</span> <span class="pre">((CENTER</span> <span class="pre">/</span> <span class="pre">FS)</span> <span class="pre">*</span> <span class="pre">(1</span> <span class="pre">&lt;&lt;</span> <span class="pre">15))</span></code>.</li>
<li><code class="docutils literal notranslate"><span class="pre">GFS</span></code> is the 500Hz gap frequency scaled according to the sample frequency, and expressed as a DDFS increment. <code class="docutils literal notranslate"><span class="pre">GFS</span></code> equals <code class="docutils literal notranslate"><span class="pre">(int)</span> <span class="pre">((GAP</span> <span class="pre">/</span> <span class="pre">FS)</span> <span class="pre">*</span> <span class="pre">(1</span> <span class="pre">&lt;&lt;</span> <span class="pre">15))</span></code>.</li>
<li><code class="docutils literal notranslate"><span class="pre">nextsymbol</span></code> is a function that returns the next symbol to be modulated, either a mark or a space.</li>
<li><code class="docutils literal notranslate"><span class="pre">coslu</span></code> is a lookup table with cosine values (encoded as Q15 numbers). <code class="docutils literal notranslate"><span class="pre">angle</span> <span class="pre">&gt;&gt;</span> <span class="pre">8</span></code> goes from 0 to 255, corresponding to an angle 0 to <img class="math" src="_images/math/70b18b02102d304259bfe6eb9e38350b5993f6d0.png" alt="2 \pi"/>.</li>
</ul>
<p>The cosine table is a straightforward mapping of a single cosine period. In a resource-constrained environment (low on memory), we would have to apply additionaal
optimization techniques, such as exploiting the symmetry of the wave. A good overview
of such optimization techniques <a class="reference external" href="https://www.stepfpga.com/doc/_media/dsp_dds1.pdf">can be found online</a>.</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">int</span> <span class="n">coslu</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
<span class="n">void</span> <span class="n">initcoslu</span><span class="p">()</span> <span class="p">{</span>
    <span class="nb">int</span> <span class="n">i</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">256</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
        <span class="n">coslu</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="p">(</span><span class="mf">0.1</span> <span class="o">*</span> <span class="n">cosf</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">M_PI</span> <span class="o">*</span> <span class="n">i</span> <span class="o">/</span> <span class="mf">256.0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">));</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">next_symbol</span></code> function depends on the information source.
In this example, we use finite state machine (FSM) that emits a steady stream of space symbols until the left button of the board (tied to <code class="docutils literal notranslate"><span class="pre">start</span></code>) is pressed. Then, the FSM goes through a ‘training’ sequence of alternating mark and space symbols, and finally ends up generating a stream of random symbols. Pressing the right button (tied to <code class="docutils literal notranslate"><span class="pre">stop</span></code>) returns the FSM to its initial state.</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">int</span> <span class="n">next_symbol</span><span class="p">(</span><span class="nb">int</span> <span class="n">start</span><span class="p">,</span> <span class="nb">int</span> <span class="n">stop</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">enum</span> <span class="p">{</span><span class="n">IDLE</span><span class="p">,</span> <span class="n">TRAINING</span><span class="p">,</span> <span class="n">ACTIVE</span><span class="p">};</span>
    <span class="n">static</span> <span class="nb">int</span> <span class="n">state</span> <span class="o">=</span> <span class="n">IDLE</span><span class="p">;</span>
    <span class="n">static</span> <span class="nb">int</span> <span class="n">trainingctr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">switch</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">case</span> <span class="n">IDLE</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">start</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">state</span> <span class="o">=</span> <span class="n">TRAINING</span><span class="p">;</span>
            <span class="n">trainingctr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="n">case</span> <span class="n">TRAINING</span><span class="p">:</span>
        <span class="n">trainingctr</span> <span class="o">=</span> <span class="n">trainingctr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">trainingctr</span> <span class="o">&lt;</span> <span class="n">TRAININGLEN</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">trainingctr</span> <span class="o">&lt;</span> <span class="n">TRAININGLEN</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">((</span><span class="n">trainingctr</span> <span class="o">-</span> <span class="n">TRAININGLEN</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="n">state</span> <span class="o">=</span> <span class="n">ACTIVE</span><span class="p">;</span>
            <span class="k">return</span> <span class="p">((</span><span class="n">trainingctr</span> <span class="o">-</span> <span class="n">TRAININGLEN</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="n">case</span> <span class="n">ACTIVE</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">stop</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">state</span> <span class="o">=</span> <span class="n">IDLE</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">start</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">state</span> <span class="o">=</span> <span class="n">TRAINING</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">rand_symbol</span><span class="p">();</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="figure align-center" id="id6" style="width: 600px">
<img alt="_images/afskexample.jpg" src="_images/afskexample.jpg" />
<p class="caption"><span class="caption-text">Spectrum and time-domain representation of an AFSK modulated stream of random symbols. The cursors are set at the mark and space frequencies (1200Hz and 2200Hz). Note that, due to the use of a DDFS, the time-domain waveform appears continuous.</span></p>
</div>
</div>
</div>
<div class="section" id="frequency-detection-goertzel-algorithm">
<h2>Frequency Detection: Goertzel Algorithm<a class="headerlink" href="#frequency-detection-goertzel-algorithm" title="Permalink to this headline">¶</a></h2>
<p>Digital Communication Systems frequently have to detect the presence of specific frequencies.
While it is possible, in principle, to compute the spectrum of a signal (for example using the
Fast Fourier Transform) and then select exactly the frequency component of interest, this
method is computationally too expensive and wasteful. Instead, we need a method that
can be tuned for a specific frequency.</p>
<p>The Goertzel filter is a filter with two poles (a complex conjugate pole pair) and one zero,
defined by the following equation.</p>
<div class="math">
<p><img src="_images/math/60934d2f4651b0aab0a7ea98c28bae24d6ea4c1f.png" alt="H(z) = \frac{1 - e^{-j 2 \pi k / N}z^{-1}}{ 1 - 2 cos(2 \pi k/N) z^{-1} + z^{-2}}"/></p>
</div><p>The numerator, <img class="math" src="_images/math/df54837900d14b17f4b5ba48c9eb835fb16001c5.png" alt="1 - 2 cos(2 \pi k/N) z^{-1} + z^{-2}"/>, is an expression we’ve encountered
before while discussing frequency-sampling FIR. This specific structure is a resonator: it
has a complex conjugate pole pair at an angle of <img class="math" src="_images/math/0cd8e601b88ed15e559ca22fd38f4b2801e9fd50.png" alt="\pm 2\pi k/N"/>. The zero of <img class="math" src="_images/math/b2bb814f83e453bb6e93d3545dd2698eaab88e9d.png" alt="H(z)"/>
will cancel the pole at angle <img class="math" src="_images/math/2a1edfbd77b776aed6e2c7ad78d8084dfe1a7db9.png" alt="- 2\pi k/N"/>, so that <img class="math" src="_images/math/b2bb814f83e453bb6e93d3545dd2698eaab88e9d.png" alt="H(z)"/> could be simplified as follows.</p>
<div class="math">
<p><img src="_images/math/fca59dddfa34db1603f6e9552a0497bbc15302a9.png" alt="H(z) = \frac{1}{1 - e^{j 2 \pi k / N}z^{-1}}"/></p>
</div><div class="figure align-center" style="width: 300px">
<img alt="_images/goertzelzplane.jpg" src="_images/goertzelzplane.jpg" />
</div>
<p>The expression for H(z) corresponds to a filter with an impulse response given by:</p>
<div class="math">
<p><img src="_images/math/eb863390eb02f3ab4241792cc6c9e74d8a2b05f1.png" alt="h(n) = u(n) . e^{-j 2 \pi k.n / N}"/></p>
</div><p>The filtering of an input signal <img class="math" src="_images/math/329b5019be424c473a2d3688402a315b2682c964.png" alt="x(n)"/> with <img class="math" src="_images/math/e03a27d36c5f27bfcbf3aff0a9ac8a69aa2961e2.png" alt="h(n)"/> yields, at time <img class="math" src="_images/math/870d9f45b86f0a06667377107b7a017b25d488b1.png" alt="n = N"/>, the output  of the DFT at frequency  <img class="math" src="_images/math/2ff2ded26810a4db46536a04d6d05b80fc2be5ac.png" alt="2 \pi k/N"/>. A Goertzel filter is this capable of computing the DFT for one particular frequency, namely the frequency we wish to detect.</p>
<div class="section" id="goertzel-filter-implementation">
<h3>Goertzel Filter Implementation<a class="headerlink" href="#goertzel-filter-implementation" title="Permalink to this headline">¶</a></h3>
<p>Goertzel filters are realized as second-order biquad sections.</p>
<div class="figure align-center" style="width: 500px">
<img alt="_images/goertzelsos.jpg" src="_images/goertzelsos.jpg" />
</div>
<p>For frequency detection purposes, we’re interested in the power present at a particular frequency; when the power level is below a given threshold will conclude that the frequency is ‘absent’, while when the power level is above that threshold, we’ll say the frequency is ‘present’.</p>
<p>From the filter structure, we can derive the following expression for <img class="math" src="_images/math/31c2d9defa3bb02c0275338bb2f283fed0222da6.png" alt="y(n)"/>, with <img class="math" src="_images/math/a3a03607d74a55f69c38119ba3797aab0f67d152.png" alt="s(n)"/> the input of the first filter tap and <img class="math" src="_images/math/4784c959df1ee7aaf927f1723758a5f57b5e73f9.png" alt="s(n-1)"/> the input of the second filter tap.</p>
<div class="math">
<p><img src="_images/math/0c94e4f57239865cc9ee9d4cf1b2f00577b155a4.png" alt="y(n) = s(n) - s(n-1) . e^{-j 2 \pi k / N}"/></p>
</div><p>Delaying everything by one cycle, we find</p>
<div class="math">
<p><img src="_images/math/7bf7b512506fc9f5ca4e24c6cb7ac726cce9573b.png" alt="y(n-1) = s(n-1) - s(n-2) . e^{-j 2 \pi k / N}"/></p>
</div><p>On a steady-state signal, the power in <img class="math" src="_images/math/e8ebc5871ed7862c32604dbfe6db42201627c916.png" alt="y(n)^2"/> will be the same as
the power in <img class="math" src="_images/math/b1a7614c916c6cfb795232673c585031d533ad03.png" alt="y(n-1)^2"/>. Therefore,
to find the power in <img class="math" src="_images/math/e8ebc5871ed7862c32604dbfe6db42201627c916.png" alt="y(n)^2"/> we compute the following expression.</p>
<div class="math">
<p><img src="_images/math/a7c837ee9ec9c2ba47ebf2ff104f962c0b38868f.png" alt="y(n-1)^2 = s(n-1)^2 + s(n-2)^2 - 2cos(2 \pi k / N).s(n-1).s(n-2)"/></p>
</div><p>We are now ready to define a practical use case of the Goertzel algorithm.</p>
</div>
<div class="section" id="goertzel-algorithm">
<h3>Goertzel algorithm<a class="headerlink" href="#goertzel-algorithm" title="Permalink to this headline">¶</a></h3>
<p>Goertzel filters are not regular steady-state filters. Similar as with a DFT, they
are computed over a window of N samples. The bigger the window, the higher the
frequency resolution of the power measurement. The following steps, known as the Goertzel
algorithm, describe how
to compute the power in a signal at a given frequency <img class="math" src="_images/math/c0a5de54dc45284e02460d22bf174a1032314c32.png" alt="f_{detect}"/>.</p>
<ol class="arabic simple">
<li>Select a frequency to detect, <img class="math" src="_images/math/32a4a7b79e21d2e4b5eb533cb8f55f898acb7ac8.png" alt="f_{detect} &lt; f_{sample}"/>.
Select a window of samples N over which the Goertzel filter will be applied.</li>
<li>Compute the filter coefficient <img class="math" src="_images/math/b0dc1980c2c83d8e67aa497e726f658b39a041a6.png" alt="C = 2.cos(2.pi.f_{detect}/f_{sample})"/>.</li>
<li>Reset the filter taps <img class="math" src="_images/math/f57427b967cef6b68e3503a3f9f18a324d2bc5fa.png" alt="s(n-1) = s(n-2) = 0"/>.</li>
<li>For N samples, compute <img class="math" src="_images/math/ae07291ade0361d9586990f5a2b62beb94c0c3d4.png" alt="s(n) = x(n) + C . s(n-1) . s(n-2)"/>.</li>
<li>After N samples, compute the power as <img class="math" src="_images/math/af786dbc4ab421f765131c516467c2aa14e2f4c3.png" alt="s(n-1) . s(n-1) + s(n-2) . s(n-2) - C . s(n-1) . s(n-2)"/>.</li>
</ol>
</div>
</div>
<div class="section" id="frequency-detection-in-action-dtmf-decoding">
<h2>Frequency Detection in action: DTMF Decoding<a class="headerlink" href="#frequency-detection-in-action-dtmf-decoding" title="Permalink to this headline">¶</a></h2>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The example code of this section is included in the repository
from this lecture as <code class="docutils literal notranslate"><span class="pre">dsp_l10_dtmf</span></code></p>
</div>
<p>Goertzel filters are commonly used for DTMF decoding - the tones that you can hear when you press the keypad of a telephone. Each key is mapped to two frequencies, according to the following table.</p>
<blockquote>
<div><table border="1" class="docutils">
<colgroup>
<col width="24%" />
<col width="25%" />
<col width="27%" />
<col width="24%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">&#160;</th>
<th class="head">1209 Hz</th>
<th class="head">1336 Hz</th>
<th class="head">1477 Hz</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><strong>697 Hz</strong></td>
<td>1</td>
<td>2</td>
<td>3</td>
</tr>
<tr class="row-odd"><td><strong>770 Hz</strong></td>
<td>4</td>
<td>5</td>
<td>6</td>
</tr>
<tr class="row-even"><td><strong>852 Hz</strong></td>
<td>7</td>
<td>8</td>
<td>9</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>A DTMF decoder for the 9 numerical keys of a touch-tone telephone thus requires six goertzel filters, one for each frequency. If we run a DSP algorithm at 8000 Hz sample rate, then 256 samples will cover 32 ms, or 22 periods of the lowest frequency and 47 periods of the highest frequency.</p>
<p>The following program illustrates a DTMF decoder. We include a data structure to capture the state of a single Goertzel filter, and then replicate it for each frequency that we need to decode. The <code class="docutils literal notranslate"><span class="pre">FRACBITS</span></code> macro is the number of fractional bits used in the design.</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">typedef</span> <span class="n">struct</span> <span class="p">{</span>
    <span class="nb">int</span> <span class="n">coef</span><span class="p">;</span>
    <span class="nb">int</span> <span class="n">s2</span><span class="p">,</span> <span class="n">s1</span><span class="p">;</span>
<span class="p">}</span> <span class="n">Gtap</span><span class="p">;</span>

<span class="n">Gtap</span> <span class="n">t697</span><span class="p">;</span>
<span class="n">Gtap</span> <span class="n">t770</span><span class="p">;</span>
<span class="n">Gtap</span> <span class="n">t852</span><span class="p">;</span>
<span class="n">Gtap</span> <span class="n">t1209</span><span class="p">;</span>
<span class="n">Gtap</span> <span class="n">t1336</span><span class="p">;</span>
<span class="n">Gtap</span> <span class="n">t1477</span><span class="p">;</span>

<span class="n">void</span> <span class="n">initgtap</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">t697</span><span class="o">.</span><span class="n">coef</span>  <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="p">(</span><span class="n">cosf</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">M_PI</span> <span class="o">*</span>   <span class="mi">697</span> <span class="o">/</span> <span class="n">FS</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">FRACBITS</span><span class="p">));</span>
    <span class="n">t770</span><span class="o">.</span><span class="n">coef</span>  <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="p">(</span><span class="n">cosf</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">M_PI</span> <span class="o">*</span>   <span class="mi">770</span> <span class="o">/</span> <span class="n">FS</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">FRACBITS</span><span class="p">));</span>
    <span class="n">t852</span><span class="o">.</span><span class="n">coef</span>  <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="p">(</span><span class="n">cosf</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">M_PI</span> <span class="o">*</span>   <span class="mi">852</span> <span class="o">/</span> <span class="n">FS</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">FRACBITS</span><span class="p">));</span>
    <span class="n">t1209</span><span class="o">.</span><span class="n">coef</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="p">(</span><span class="n">cosf</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">M_PI</span> <span class="o">*</span>  <span class="mi">1209</span> <span class="o">/</span> <span class="n">FS</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">FRACBITS</span><span class="p">));</span>
    <span class="n">t1336</span><span class="o">.</span><span class="n">coef</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="p">(</span><span class="n">cosf</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">M_PI</span> <span class="o">*</span>  <span class="mi">1336</span> <span class="o">/</span> <span class="n">FS</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">FRACBITS</span><span class="p">));</span>
    <span class="n">t1477</span><span class="o">.</span><span class="n">coef</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="p">(</span><span class="n">cosf</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">M_PI</span> <span class="o">*</span>  <span class="mi">1477</span> <span class="o">/</span> <span class="n">FS</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">FRACBITS</span><span class="p">));</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Using the <code class="docutils literal notranslate"><span class="pre">Gtap</span></code> record, we then implement the Goertzel filter functionality. `` samplegoertzel`` updates the filter state with a new sample, <code class="docutils literal notranslate"><span class="pre">resetgoertzel</span></code> clears the filter state, and <code class="docutils literal notranslate"><span class="pre">powergoertzel</span></code> computes the power of the filtered output signal. All of these functions are derived from our earlier analysis.</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">void</span> <span class="n">samplegoertzel</span><span class="p">(</span><span class="n">Gtap</span> <span class="o">*</span><span class="n">t</span><span class="p">,</span> <span class="nb">int</span> <span class="n">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">int</span> <span class="n">s0</span><span class="p">;</span>
    <span class="n">s0</span>    <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">FIXMUL</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">s1</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">coef</span><span class="p">)</span> <span class="o">-</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">s2</span><span class="p">;</span>
    <span class="n">t</span><span class="o">-&gt;</span><span class="n">s2</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">s1</span><span class="p">;</span>
    <span class="n">t</span><span class="o">-&gt;</span><span class="n">s1</span> <span class="o">=</span> <span class="n">s0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">void</span> <span class="n">resetgoertzel</span><span class="p">(</span><span class="n">Gtap</span> <span class="o">*</span><span class="n">t</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">t</span><span class="o">-&gt;</span><span class="n">s1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">t</span><span class="o">-&gt;</span><span class="n">s2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="nb">int</span> <span class="n">powergoertzel</span><span class="p">(</span><span class="n">Gtap</span> <span class="o">*</span><span class="n">t</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">FIXMUL</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">s1</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">s1</span><span class="p">)</span> <span class="o">+</span>
            <span class="n">FIXMUL</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">s2</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">s2</span><span class="p">)</span> <span class="o">-</span>
            <span class="n">FIXMUL</span><span class="p">(</span><span class="n">FIXMUL</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">coef</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">s1</span><span class="p">),</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">s2</span><span class="p">));</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Next, to decode DTMF signals, we have to run six Goertzel filters in parallel. When decoding the power output, we are looking for two filters with an above-threshold output, representing the column and row of the pressed key. The <code class="docutils literal notranslate"><span class="pre">PTHRESHOLD</span></code> macro is an experimentally derived constant, equal to 1000 in the example.</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">void</span> <span class="n">dtmfreset</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">resetgoertzel</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">t697</span><span class="p">);</span>
    <span class="n">resetgoertzel</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">t770</span><span class="p">);</span>
    <span class="n">resetgoertzel</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">t852</span><span class="p">);</span>
    <span class="n">resetgoertzel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t1209</span><span class="p">);</span>
    <span class="n">resetgoertzel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t1336</span><span class="p">);</span>
    <span class="n">resetgoertzel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t1477</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">void</span> <span class="n">dtmfaddsample</span><span class="p">(</span><span class="nb">int</span> <span class="n">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">samplegoertzel</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">t697</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
    <span class="n">samplegoertzel</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">t770</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
    <span class="n">samplegoertzel</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">t852</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
    <span class="n">samplegoertzel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t1209</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
    <span class="n">samplegoertzel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t1336</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
    <span class="n">samplegoertzel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t1477</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
<span class="p">}</span>

<span class="o">//</span> <span class="c1">#define DTMFDEBUG</span>

<span class="nb">int</span> <span class="n">dtmfdecode</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">unsigned</span> <span class="n">p697</span>  <span class="o">=</span> <span class="n">powergoertzel</span><span class="p">(</span>  <span class="o">&amp;</span><span class="n">t697</span><span class="p">);</span>
    <span class="n">unsigned</span> <span class="n">p770</span>  <span class="o">=</span> <span class="n">powergoertzel</span><span class="p">(</span>  <span class="o">&amp;</span><span class="n">t770</span><span class="p">);</span>
    <span class="n">unsigned</span> <span class="n">p852</span>  <span class="o">=</span> <span class="n">powergoertzel</span><span class="p">(</span>  <span class="o">&amp;</span><span class="n">t852</span><span class="p">);</span>
    <span class="n">unsigned</span> <span class="n">p1209</span> <span class="o">=</span> <span class="n">powergoertzel</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">t1209</span><span class="p">);</span>
    <span class="n">unsigned</span> <span class="n">p1336</span> <span class="o">=</span> <span class="n">powergoertzel</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">t1336</span><span class="p">);</span>
    <span class="n">unsigned</span> <span class="n">p1477</span> <span class="o">=</span> <span class="n">powergoertzel</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">t1477</span><span class="p">);</span>

<span class="c1">#ifdef DTMFDEBUG</span>
    <span class="n">printf</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%5d</span><span class="s2"> </span><span class="si">%5d</span><span class="s2"> </span><span class="si">%5d</span><span class="s2"> </span><span class="si">%5d</span><span class="s2"> </span><span class="si">%5d</span><span class="s2"> </span><span class="si">%5d</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">p697</span><span class="p">,</span> <span class="n">p770</span><span class="p">,</span> <span class="n">p852</span><span class="p">,</span> <span class="n">p1209</span><span class="p">,</span> <span class="n">p1336</span><span class="p">,</span> <span class="n">p1477</span><span class="p">);</span>
<span class="c1">#endif</span>

    <span class="nb">int</span> <span class="n">d697</span>  <span class="o">=</span> <span class="p">(</span><span class="n">p697</span>  <span class="o">&gt;</span> <span class="n">PTHRESHOLD</span><span class="p">);</span>
    <span class="nb">int</span> <span class="n">d770</span>  <span class="o">=</span> <span class="p">(</span><span class="n">p770</span>  <span class="o">&gt;</span> <span class="n">PTHRESHOLD</span><span class="p">);</span>
    <span class="nb">int</span> <span class="n">d852</span>  <span class="o">=</span> <span class="p">(</span><span class="n">p852</span>  <span class="o">&gt;</span> <span class="n">PTHRESHOLD</span><span class="p">);</span>
    <span class="nb">int</span> <span class="n">d1209</span> <span class="o">=</span> <span class="p">(</span><span class="n">p1209</span> <span class="o">&gt;</span> <span class="n">PTHRESHOLD</span><span class="p">);</span>
    <span class="nb">int</span> <span class="n">d1336</span> <span class="o">=</span> <span class="p">(</span><span class="n">p1336</span> <span class="o">&gt;</span> <span class="n">PTHRESHOLD</span><span class="p">);</span>
    <span class="nb">int</span> <span class="n">d1477</span> <span class="o">=</span> <span class="p">(</span><span class="n">p1477</span> <span class="o">&gt;</span> <span class="n">PTHRESHOLD</span><span class="p">);</span>

    <span class="o">//</span> <span class="o">-</span> <span class="k">if</span> <span class="n">three</span> <span class="ow">or</span> <span class="n">more</span> <span class="n">thresholds</span> <span class="n">are</span> <span class="n">exceeded</span><span class="p">,</span>
    <span class="o">//</span>   <span class="n">we</span> <span class="n">will</span> <span class="n">reject</span> <span class="n">this</span> <span class="k">as</span> <span class="n">valid</span> <span class="n">dtmf</span><span class="p">,</span> <span class="n">it</span><span class="s1">&#39;s</span>
    <span class="o">//</span>   <span class="n">noise</span> <span class="ow">or</span> <span class="n">a</span> <span class="n">background</span> <span class="n">sound</span>
    <span class="o">//</span> <span class="o">-</span> <span class="k">if</span> <span class="n">two</span> <span class="n">thresholds</span> <span class="n">are</span> <span class="n">exceeded</span><span class="p">,</span> <span class="n">we</span> <span class="k">try</span> <span class="n">to</span>
    <span class="o">//</span>   <span class="n">decoded</span> <span class="k">as</span> <span class="n">a</span> <span class="n">valid</span> <span class="n">dtmf</span> <span class="n">combination</span>
    <span class="o">//</span> <span class="o">-</span> <span class="ow">in</span> <span class="nb">all</span> <span class="n">other</span> <span class="n">cases</span><span class="p">,</span> <span class="n">we</span> <span class="n">reject</span> <span class="n">this</span> <span class="n">tone</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">d697</span> <span class="o">+</span> <span class="n">d770</span> <span class="o">+</span> <span class="n">d852</span> <span class="o">+</span> <span class="n">d1209</span> <span class="o">+</span> <span class="n">d1336</span> <span class="o">+</span> <span class="n">d1477</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">d852</span> <span class="o">&amp;&amp;</span> <span class="n">d1477</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">9</span><span class="p">;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">d852</span> <span class="o">&amp;&amp;</span> <span class="n">d1336</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">8</span><span class="p">;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">d852</span> <span class="o">&amp;&amp;</span> <span class="n">d1209</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">7</span><span class="p">;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">d770</span> <span class="o">&amp;&amp;</span> <span class="n">d1477</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">6</span><span class="p">;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">d770</span> <span class="o">&amp;&amp;</span> <span class="n">d1336</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">5</span><span class="p">;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">d770</span> <span class="o">&amp;&amp;</span> <span class="n">d1209</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">4</span><span class="p">;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">d697</span> <span class="o">&amp;&amp;</span> <span class="n">d1477</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">3</span><span class="p">;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">d697</span> <span class="o">&amp;&amp;</span> <span class="n">d1336</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">d697</span> <span class="o">&amp;&amp;</span> <span class="n">d1209</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Finally, the integrate the DTMF decoder in an interrupt driven DSP system, blocks of 256 samples are fed into the DTMF decoder, and each time a new output is detect, the decoded value is printed. This example code returns the value sampled by the microphone, so when you run this code <strong>you should turn down the volume to avoid feedback</strong>.</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">int</span> <span class="n">samplectr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="c1">#define GWINDOW 256</span>
<span class="nb">int</span> <span class="n">lastdtmf</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

<span class="n">uint16_t</span> <span class="n">processSample</span><span class="p">(</span><span class="n">uint16_t</span> <span class="n">s</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">int</span> <span class="n">x</span> <span class="o">=</span> <span class="n">adc14_to_q15</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>

    <span class="n">samplectr</span> <span class="o">=</span> <span class="p">(</span><span class="n">samplectr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">GWINDOW</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">samplectr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="nb">int</span> <span class="n">newdtmf</span> <span class="o">=</span> <span class="n">dtmfdecode</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">newdtmf</span> <span class="o">!=</span> <span class="n">lastdtmf</span><span class="p">)</span>
            <span class="n">printf</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">newdtmf</span><span class="p">);</span>
        <span class="n">lastdtmf</span> <span class="o">=</span> <span class="n">newdtmf</span><span class="p">;</span>
        <span class="n">dtmfreset</span><span class="p">();</span>
    <span class="p">}</span> <span class="k">else</span>
        <span class="n">dtmfaddsample</span><span class="p">(</span><span class="n">x</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">15</span> <span class="o">-</span> <span class="n">FRACBITS</span><span class="p">));</span>

    <span class="k">return</span> <span class="n">q15_to_dac14</span><span class="p">(</span><span class="n">x</span><span class="p">);</span> <span class="o">//</span> <span class="n">silence</span>
<span class="p">}</span>

<span class="nb">int</span> <span class="n">main</span><span class="p">(</span><span class="n">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">WDT_A_hold</span><span class="p">(</span><span class="n">WDT_A_BASE</span><span class="p">);</span>

    <span class="n">initgtap</span><span class="p">();</span>
    <span class="n">dtmfreset</span><span class="p">();</span>

    <span class="n">msp432_boostxl_init_intr</span><span class="p">(</span><span class="n">FS_HZ</span><span class="p">,</span> <span class="n">BOOSTXL_MIC_IN</span><span class="p">,</span> <span class="n">processSample</span><span class="p">);</span>
    <span class="n">msp432_boostxl_run</span><span class="p">();</span>

    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="figure align-center" id="id7" style="width: 600px">
<img alt="_images/dtmfexample.jpg" src="_images/dtmfexample.jpg" />
<p class="caption"><span class="caption-text">Spectrum and time-domain representation of a DTMF signal corresponding to keypad number ‘4’. The markers are located at about 770Hz and 1209 Hz.</span></p>
</div>
</div>
<div class="section" id="conclusions">
<h2>Conclusions<a class="headerlink" href="#conclusions" title="Permalink to this headline">¶</a></h2>
<p>We discussed two concepts that are important in the implementation of digital communication systems: frequency synthesis and frequency detection.
The AFSK modulator, described in the first half of the lecture, will be used in the coming lab (Lab 6) which will address AFSK demodulation.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="labs.html" class="btn btn-neutral float-right" title="Labs" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="lecture9.html" class="btn btn-neutral" title="L9: Adaptive Filters" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Patrick Schaumont.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>